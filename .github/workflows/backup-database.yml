name: Database Backup

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 0" # weekly backup at 04:00 UTC every Sunday

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-db-backup

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GHCR_USER }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{date 'YYYYMMDD'}}-

      - name: Build and push backup image
        uses: docker/build-push-action@v5
        with:
          context: ./infra/backup
          file: ./infra/backup/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Trigger backup on droplet
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ vars.DO_SSH_HOST }}
          username: ${{ vars.DO_SSH_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            cd /root/deploy
            
            # Pull latest backup image
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
            # Update stack to use new image
            docker stack deploy -c stack.yml eventmap --with-registry-auth
            
            # Run backup
            echo "[*] Starting backup service..."
            docker service update --detach=true --replicas 1 eventmap_db_backup
            
            # Wait for task to complete (check every 5 seconds for up to 5 minutes)
            echo "[*] Waiting for backup to complete..."
            for i in {1..60}; do
              sleep 5
              
              # Get current task state
              STATE=$(docker service ps eventmap_db_backup --format '{{.CurrentState}}' --no-trunc | head -n1)
              echo "[$i] Current state: $STATE"
              
              # Check if task completed
              if echo "$STATE" | grep -q "Complete"; then
                echo "[✓] Backup task completed successfully"
                
                # Get task logs
                TID=$(docker service ps --no-trunc --format '{{.ID}}' eventmap_db_backup | head -n1)
                echo "[*] Task ID: $TID"
                echo "[*] Fetching logs..."
                docker service logs eventmap_db_backup --no-trunc --tail 50
                
                # Scale back to 0
                echo "[*] Scaling service back to 0 replicas..."
                docker service update --replicas 0 eventmap_db_backup
                
                # Verify backup was uploaded by checking logs for success message
                if docker service logs eventmap_db_backup --no-trunc --tail 50 2>&1 | grep -q "Backup uploaded successfully"; then
                  echo "[✓] Backup verified - uploaded to Spaces successfully"
                  exit 0
                else
                  echo "[✗] Backup may have failed - upload success message not found"
                  exit 1
                fi
              fi
              
              # Check if task failed with error
              if echo "$STATE" | grep -q "Failed"; then
                echo "[✗] Backup task failed"
                docker service logs eventmap_db_backup --no-trunc --tail 50
                docker service update --replicas 0 eventmap_db_backup
                exit 1
              fi
            done
            
            # Timeout - task didn't complete in 5 minutes
            echo "[✗] Timeout waiting for backup to complete"
            docker service logs eventmap_db_backup --no-trunc --tail 50
            docker service update --replicas 0 eventmap_db_backup
            exit 1

      - name: Notify on failure
        if: failure()
        run: echo "Database backup failed. Check logs for details."
